##### Docker Compose
``Docker Compose`` — это инструмент для определения и запуска многоконтейнерных приложений. Это ключ к открытию оптимизированного и эффективного опыта разработки и развертывания.<br>
``Compose`` упрощает управление всем стеком приложений, облегчая управление службами, сетями и томами в одном понятном файле конфигурации YAML. Затем с помощью одной команды вы создаете и запускаете все службы из своего файла конфигурации.<br>

``Compose`` работает во всех средах: производство, подготовка, разработка, тестирование, а также рабочие процессы CI. Он также имеет команды для управления всем жизненным циклом вашего приложения:

- Запуск, остановка и перестройка служб
- Просмотр статуса запущенных служб
- Потоковая передача журнала запущенных служб
- Выполнить одноразовую команду для службы

![3](https://github.com/user-attachments/assets/31c11503-ffb4-4b48-bb31-cb5967ca7dde)

С июля 2023 года Compose V1 перестал получать обновления. Он также больше не доступен в новых выпусках Docker Desktop.<br>
Compose V2, впервые выпущенный в 2020 году, включен во все поддерживаемые в настоящее время версии Docker Desktop.<br>Он предлагает улучшенный интерфейс командной строки, улучшенную производительность сборки с помощью BuildKit и продолжение разработки новых функций.

##### В чем разница между Compose V1 и Compose V2?

В Compose ``V1 _ ``в качестве разделителя слов использовался символ подчеркивания (_). В Compose ``V2 - `` в качестве разделителя слов используется дефис (-).<br>
Подчеркивания не являются допустимыми символами в именах хостов DNS. Используя вместо них дефис, Compose V2 обеспечивает доступ к контейнерам служб по сети через последовательные, предсказуемые имена хостов.<br>
Например, запуск команды ``Compose -p myproject up --scale=1 svc`` приводит к созданию контейнера ``myproject_svc_1с именем Compose V1`` и контейнера ``myproject-svc-1с`` именем Compose V2.<br>

Compose V2 поддерживает почти все флаги и подкоманды Compose V1, поэтому в большинстве случаев его можно использовать в качестве замены в скриптах.

###### Не поддерживается в V2
Следующие функции устарели в Compose V1 и не поддерживаются в Compose V2:<br>
``- docker-compose scale. docker compose up --scale``<br>
Вместо этого используйте<br>
``- docker-compose rm --all``

###### Отличается в V2
Следующие функции ведут себя по-разному в Compose V1 и V2:

 Следующие функции                  |Составить V1	         |Сочинить V2                                                                                
------------------------------------|----------------------|--------------------------------------------------------------------------------
``--compatibility``	                | Устарело. Переносит поля YAML на основе устаревшей версии схемы  | Используется _как разделитель слов для имен контейнеров вместо -соответствия V1
``ps --filter KEY-VALUE	``          | Недокументировано. Позволяет фильтровать по произвольным свойствам сервиса| Позволяет фильтровать только по определенным свойствам, например ``--filter=status=running``

Поведение переменных среды в Compose V1 не было официально документировано и в некоторых крайних случаях вело себя непоследовательно.<br>
Для Compose V2 раздел «Переменные среды» охватывает как приоритет , так и .envинтерполяцию файлов и содержит множество примеров, охватывающих сложные ситуации, такие как экранирование вложенных кавычек.<br>
Для большинства проектов переход на Compose V2 не требует внесения изменений в Compose YAML или рабочий процесс разработки.<br>
Рекомендуется адаптироваться к новому предпочтительному способу запуска Compose V2, который заключается в использовании ``docker compose`` вместо ``docker-compose``. Это обеспечивает дополнительную гибкость и устраняет необходимость в ``docker-compose`` псевдониме совместимости.<br>
Однако ``Docker Desktop`` продолжает поддерживать ``docker-compose`` псевдоним для перенаправления команд для ``docker compose`` удобства и улучшения совместимости со сторонними инструментами и скриптами.<br>
Поскольку Compose V1 и V2 именуют контейнеры служб по-разному , запуск upс использованием V2 в первый раз в проекте с работающими службами, изначально запущенными V1, приводит к повторному созданию контейнеров служб с обновленными именами.<br>
Обратите внимание, что даже если ``--compatibility`` флаг используется для сохранения стиля именования V1, Compose все равно необходимо заново создать контейнеры служб, изначально запущенные V1, при первом upзапуске V2 для миграции внутреннего состояния.<br>
> [!WARNING]  
>  Compose V2 теперь включен в официальный образ Docker на Docker Hub<br>
> Кроме того, новый образ ``docker/compose-bi``n на ``Docker Hub`` содержит последнюю версию Compose V2 для использования в многоэтапных сборках

##### Как запустить Docker Compose

- Создайте каталог для проекта:
```python
 mkdir composetest
 cd composetest
```
- Создайте файл с именем ``app.py`` в каталоге вашего проекта и вставьте в него следующий код:
```python
import time

import redis
from flask import Flask

app = Flask(__name__)
cache = redis.Redis(host='redis', port=6379)

def get_hit_count():
    retries = 5
    while True:
        try:
            return cache.incr('hits')
        except redis.exceptions.ConnectionError as exc:
            if retries == 0:
                raise exc
            retries -= 1
            time.sleep(0.5)

@app.route('/')
def hello():
    count = get_hit_count()
    return f'Hello World! I have been seen {count} times.\n'
```
> [!WARNING]  
> В этом примере ``redis`` — имя хоста контейнера ``Redis`` в сети приложения и порт по умолчанию ``6379``.

- Создайте еще один файл с именем ``requirements.txt`` в каталоге вашего проекта и вставьте в него следующий код:
```python
flask
redis
```
- Создайте Dockerfileи вставьте следующий код:
```python
# syntax=docker/dockerfile:1
FROM python:3.10-alpine
WORKDIR /code
ENV FLASK_APP=app.py
ENV FLASK_RUN_HOST=0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt
EXPOSE 5000
COPY . .
CMD ["flask", "run", "--debug"]
```
> [!WARNING]  
> Проверьте, что ``Dockerfileу`` файла нет расширения, например ``.txt``. Некоторые редакторы могут добавлять это расширение файла автоматически, что приводит к ошибке при запуске приложения.

- Создайте файл с именем compose.yamlв каталоге вашего проекта и вставьте следующее:
```python
services:
  web:
    build: .
    ports:
      - "8000:5000"
  redis:
    image: "redis:alpine"
```
В этом файле Compose определены две службы: ``web`` и ``redis``.

Служба ``web`` использует образ, созданный из ``Dockerfileв`` текущем каталоге. Затем она привязывает контейнер и хост-машину к открытому порту, 8000. Этот пример службы использует порт по умолчанию для веб-сервера Flask, 5000.

Сервис ``redis`` использует общедоступный образ ``Redis``, извлеченный из реестра ``Docker Hub``.

#### Установка контролера домена ALD PRO  на Astra Linux 1.8.2 будет состоять из двух этапов.

- Предварительная подготовка сервера.
- Установка ALD Pro.

##### Предварительная подготовка сервера.

Что надо знать?
1. Устанавливаем рекомендованную версию 1.8.х Смоленск<br>
2. ALD Pro не поддерживает ядра hardened. Поддерживаются только generic ядра.<br>
3. Минимальное количество мегабайт оперативной памяти **4Гб**, необходимое для развертывания служб контроллера домена ALD Pro. Развертывание контроллера на узле запускается только в том случае, когда на нем установлено количество оперативной памяти большее или равное указанному. Значение по умолчанию – 4096 (4Гб).
4. Для установки ALD PRO необходимо использовать редакцию Astra Linux с максимальным уровнем защищенности – **Смоленск** или усиленным уровнем защищенности – **Воронеж**.<br>**Орел** – вариант лицензирования несертифицированной ОС с базовым уровнем защищенности, не может применяться в системах, где предъявляются требования в части защиты информации.<br>
   > Переключает и отображает уровни защищенности ОС:<br>
   
       0  Базовый;
       1  Усиленный;
       2  Максимальный.
5. Для установки ALD PRO настоятельно рекомендуется использовать статическую адресацию на серверах.<br>
6. Для имени домена рекомендуется выбирать такое имя, которые не будет конфликтовать с другими вашими сервисами.
      - Например, для LAD Pro выделить отдельный домен подуровня(третьего уровня). Например, it.company.lan.

Поехали!

Устанавливаем рекомендованную версию 1.8.х Смоленск<br>
![image](https://github.com/user-attachments/assets/7853cc8d-5e04-464b-863d-9b860f443e25)
![image](https://github.com/user-attachments/assets/583ffa58-0ac9-4742-b637-97e4a16dd2be)
![image](https://github.com/user-attachments/assets/60e855f7-dc61-479c-b0ee-930761484c83)
![image](https://github.com/user-attachments/assets/d9f5e722-8e89-4d71-bd65-6a9e294e4a09)
![image](https://github.com/user-attachments/assets/cb496718-fbd4-4710-ae35-e4977bb1b949)
![image](https://github.com/user-attachments/assets/6bb21d0c-b89b-4862-82da-4e1121ea96fd)

Заходим, открываем консоль, вводим ``nano /etc/apt/sources.list`` снимаем комментарии с двух репозиторий и обновляемся.

![image](https://github.com/user-attachments/assets/5f12e745-ad7c-453d-84be-1bb102f213f4)

Или прописать в ручную.

>[!Warning]
>Репозиторий base включает репозитории main и update, а репозиторий extended содержит большое количество дополнительного программного обеспечения.

Вводим команду ``nano /etc/apt/sources.list`` проверенные рабочие
```bash
# Основной репозиторий, включающий актуальное оперативное или срочное обновление
deb https://dl.astralinux.ru/astra/stable/1.8_x86-64/main-repository/ 1.8_x86-64 main contrib non-free non-free-firmware
# Расширенный репозиторий, соответствующий актуальному оперативному обновлению
deb https://dl.astralinux.ru/astra/stable/1.8_x86-64/extended-repository/ 1.8_x86-64 main contrib non-free non-free-firmware
```

Проверим и добавим службу синхронизации времени chrony в автозапуск (по умочанию она не установлена).

![image](https://github.com/user-attachments/assets/41251a57-86e1-415c-bfff-bb43cd9eb730)

>[!Warning]
>Серверная служба chronyd (пакет chrony) Может обеспечивать работу ОС в режиме как сервера точного времени, так и клиента. Является штатной службой времени для использования с контроллерами домена FreeIPA.

Предложение установить пакет dnsutils тоже примите.
```bash
sudo apt install chrony
sudo apt install dnsutils
```
```bash
sudo systemctl start chrony
sudo systemctl enable chrony 
```
Добавим Российские NTP сервера и можно указать разрешённую сеть для клиентов.
Вводим ``nano /etc/chrony/chrony.conf`` и добавляем эти строки
```bash
server 0.ru.pool.ntp.org iburst
server 1.ru.pool.ntp.org iburst
server 2.ru.pool.ntp.org iburst
server 3.ru.pool.ntp.org iburst
allow 192.168.25.0/24
```
После настройки сервера нужно перезапустить службу: ``sudo systemctl restart chrony``

Проверим источники времени:``sudo chronyc -N sources``

Проверим порт. Сервер времени chrony, также как и другие NTP сервера слушает порт udp 123: ``sudo ss -ulpn | grep chronyd``

Можем посмотреть количество активных и не активных источников: ``sudo chronyc activity``

Сделаем перезагрузку и убедимся, что служба запускается автоматически.

![image](https://github.com/user-attachments/assets/6d799da1-7d2e-4922-98af-8f491016776f)

>[Warning]
>Далее нужно, на остальных серверах, прописать наш сервер Chrony в качестве источника синхронизации времени.
>Для этого укажем его адрес в ``/etc/systemd/timesyncd.conf`` на остальных серверах. А затем перезапустим службу синхронизации времени
```bash
[Time]
NTP=192.168.25.103
```
При необходимости увеличить таймайт запроса проля sudo.(не обязательно) 
Допишите в конце строки через запятую следующую опцию timestamp_timeout=x. Должно получиться так:
```bash
Defaults env_reset, timestamp_timeout=30
```
##### Настраиваем сеть.
Узнаём название сетевого интерфейса, IP адресс, шлюз
```bash
ip a | grep inet 
route 
```
![image](https://github.com/user-attachments/assets/24f34193-4e79-4b9a-9008-199dbd82dd6b)

Дальше делаем так:
```bash
sudo systemctl status NetworkManager //проверяем статус службы NetworkManager
sudo systemctl stop NetworkManager //останавливает службу
sudo systemctl disable NetworkManager //удаляет её из автозагрузки
sudo systemctl mask NetworkManager //останавливает активность службы
astra-noautonet-control disable // выключаем оснастку NetworkManager
```
Установливаем статический IP адрес.

Настраиваем статический адрес вводим команду: ``nano /etc/network/interfaces``
```bash
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

auto ens33
allow-hotplug ens33
iface ens33 inet static
address 192.168.25.103
netmask 255.255.255.0
gateway 192.168.25.10
```
Перезапустим сетевой интерфейс для применения настроек
```bash 
systemctl restart networking.service
```
Отключаем ipv6 на всех интерфейсах кроме lo
>[!Warning]
>Отключение IPv6 настройкой параметров ядра сделано в ОС Astra Linux по умолчанию (см. выше файл /etc/sysctl.d/999-astra.conf), однако при наличии загруженного модуля ядра IPv6 служба NetworkManager по умолчанию сама назначает сетевым интерфейсам адреса IPv6. 
>Независимо от используемой аппаратной платформы для успешной работы серверов (реплик) FreeIPA сетевой интерфейс обратной петли (loopback, lo) должен иметь адрес IPv6.

nano  /etc/sysctl.d/999-astra.conf
```bash
# Astra sysctl config

kernel.sysrq = 0
fs.suid_dumpable = 0
kernel.randomize_va_space = 2
net.ipv4.tcp_timestamps = 0
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 0
```
Применяем настройки
```bash
sysctl --system
```
![image](https://github.com/user-attachments/assets/308546d1-7905-4fa8-bfa5-27159e7b3204)

Также в файл hosts добавим строки с именем сервера ``nano /etc/hosts``.
```bash
127.0.0.1       localhost.localdomain localhost
# 127.0.1.1     srvdc01.it.dom.lan srvdc01   --обязательно закомментировать
192.168.25.103  srvdc01.it.dom.lan srvdc01

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```
![image](https://github.com/user-attachments/assets/2eb1353e-bbf6-4953-8e9c-59f5dc17cd8d)

Настраиваем ``FQDN`` имя первого контроллера домена:
```bash
hostnamectl set-hostname srvdc01.it.dom.lan
```
Перезапустим сетевой интерфейс для применения настроек
```bash 
systemctl restart networking.service
```
Проверяем
```bash
hostname -s && hostname -f
ifquery ens33
```
Вводим команду ``nano /etc/resolv.conf`` и прописываем DNS, чтобы пока у нас работали репозитории
```bash
search it.dom.lan
nameserver 77.88.8.8
```
Проверили, что работает

![image](https://github.com/user-attachments/assets/ad1996d2-8425-414b-8084-26a359948ac5)







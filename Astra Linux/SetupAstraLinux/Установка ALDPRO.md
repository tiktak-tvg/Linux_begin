#### Установка контролера домена ALD PRO будет состоять из двух этапов.

- Предварительная подготовка сервера.
- Установка ALD Pro.

##### Предварительная подготовка сервера.

Что надо знать?
1. Рекомендуемые версии такие с 1.7.4-24.04.2023_14.23 до 1.7.6.15-15.11.24_17.20 Смоленск<br>
2. ALD Pro не поддерживает ядра hardened. Поддерживаются только generic ядра.<br>
3. Минимальное количество мегабайт оперативной памяти, необходимое для развертывания служб контроллера домена ALD Pro. Развертывание контроллера на узле запускается только в том случае, когда на нем установлено количество оперативной памяти большее или равное указанному. Значение по умолчанию – 4096 (4 ГБ).
4. Необходимо использовать редакцию Astra Linux с максимальным уровнем защищенности – Смоленск.<br>
   > Переключает и отображает уровни защищенности ОС:
         - 0 Базовый;
   - 1 Усиленный;
   - 2 Максимальный.
5. Настоятельно рекомендуется использовать статическую адресацию на серверах.<br>
6. Для имени домена рекомендуется выбирать такое имя, которые не будет конфликтовать с другими вашими сервисами.
      - Например, для LAD Pro выделить отдельный домен подуровня(третьего уровня). Например, ald.it.lan.

Проверяем на рекомендуемое соответствие
```bash
cat /etc/astra/build_version
sudo astra-modeswitch getname
sudo astra-modeswitch list
если режим другой, то выбирайте нужный
sudo astra-modeswitch set 2
```
![image](https://github.com/user-attachments/assets/16412750-3ebf-4877-8c58-3962a933da4c)

Настраиваем сеть и установливаем статический IP адрес.
```bash
sudo systemctl stop NetworkManager //останавливает службу
sudo systemctl disable NetworkManager //удаляет её из автозагрузки
sudo systemctl mask NetworkManager //
astra-noautonet-control is-enabled 
astra-noautonet-control enable //отключает автоматическую настройку сетевых подключений, блокируя работу служб NetworkManager, network-manager и connman, а также отключает элемент управления сетью в трее графического интерфейса.
```
Если всё правильно сделали, то вводим команду ``sudo systemctl status NetworkManager``

![image](https://github.com/user-attachments/assets/cd97eba1-f772-48eb-b7db-fb13d2785baa)

![image](https://github.com/user-attachments/assets/d7ecd977-c8da-4deb-bee6-3f5a0e3046ec)


```bash
nano /etc/network/interfaces

# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

auto eth0
allow-hotplug eth0
iface eth0 inet static
address 192.168.25.112
netmask 255.255.255.0
gateway 192.168.25.10
```
```bash
nano /etc/resolv.conf

# auto-generated by IPA installer
#search dc01.my.cop.lan
nameserver 192.168.25.10
```

Настроим FQDN имя первого контроллера домена:
```bash
hostnamectl set-hostname dc01.my.cop.lan
```

Также в файл hosts добавим строки с именем сервера.
```bash
nano /etc/hosts

#astra-freeipa-server
127.0.0.1 localhost localhost.localdomain
192.168.25.112  dc1.ald.it.lan dc1

::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```
```bash 
reboot
```
Обновим
```bash
apt update
apt dist-upgrade
```
Можно добавить репозитории от astra
```bash
astra-update -a -r
```
```bash
reboot
```
Добавляем репозитории
```bash
cat /etc/apt/sources.list
nano /etc/apt/sources.list
# Astra Linux repository description https://wiki.astralinux.ru/x/0oLiC
# Основной репозиторий
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-main/     1.7_x86-64 main contrib non-free
# Оперативные обновления основного репозитория
deb https://dl.astralinux.ru/astra/stable/1.7_x86-64/repository-update/   1.7_x86-64 main contrib non-free

deb https://dl.astralinux.ru/astra/frozen/1.7_x86-64/1.7.3/repository-base/          1.7_x86-64 main contrib non-free
deb https://dl.astralinux.ru/astra/frozen/1.7_x86-64/1.7.3/repository-extended/      1.7_x86-64 main contrib non-free
deb https://dl.astralinux.ru/astra/frozen/1.7_x86-64/1.7.3/uu/2/repository-base/     1.7_x86-64 main contrib non-free
deb https://dl.astralinux.ru/astra/frozen/1.7_x86-64/1.7.3/uu/2/repository-extended/ 1.7_x86-64 main contrib non-free
```
в папкe source.list.d добавить файл с записью
```bash
cat > /etc/apt/sources.list.d/aldpro.list
#deb https://dl.astralinux.ru/aldpro/frozen/01/2.3.0 1.7_x86-64 main base
deb https://dl.astralinux.ru/aldpro/frozen/01/2.5.0 1.7_x86-64 main base
```


apt update
 apt list --upgradable
 apt dist-upgrade -y -o Dpkg::Optoins::=--force-confnew

Установка первого контроллера ALD Pro





После предварительной настройки, перезагружаем и продолжаем подготавливать первый контроллер домена.

Отключаем 
```bash
sudo systemctl stop NetworkManager - останавливаем службу
sudo systemctl disable NetworkManager убираем из автозагрузки
sudo systemctl mask NetworkManager - делаем маску чтобы её случайно не запустили
sudo systemctl status NetworkManager - проверяем что всё отключено
```
Далее, настраиваем сетевой интерфейс ``nano /etc/network/interfaces``

```bash
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

auto eth0
allow-hotplug eth0
iface eth0 inet static
address 192.168.25.115
netmask 255.255.255.0
```
переименовываем компьютер ``hostnamectl set-hostname dc01.tiktak.moscow.lan``

Проверяем

```bash
hostname
hostname -s
hostname -f
```

Правим файл DNS, куда впевую очередь отправляется система
```bash
nano /etc/hosts
#astra-freeipa-server
127.0.0.1 localhost localhost.localdomain
192.168.25.115 dc01.tiktak.moscow.lan dc01
```
P.s. Почему домен поддомен второго уровня и не .local а .lan, так рекомендуют. Делаем всё по фешую.
В документации и обучающих курсах применяются домены contoso.com или ad.example.test, которые используют для обучающих целей, но не приемлемы для развёртывания продуктивных сред. 
Поэтому рекомендуется придерживаться следующих правил: 
- Лучший вариант- это использовать свой домен третьего уровня. Например, если организация приобрела домен mycompany.ru для своего Web-сайта и почты, то для ALD Pro можно использовать доменное имя третьего уровня ald.mycompany.ru. 28Если в группе компаний планируется несколько юридических лиц, то каждому юр. лицу можно создать домен четвертого уровня. 
Таким образом будет гарантироваться отсутствие конфликтов с публичными DNS-именами.
- Если публичный домен не используется, то можно задействовать зоны .lan или .internal, например, ald.company.lan. Во многих инструкциях упоминается возможность использования зоны .local в качестве частного домена верхнего уровня для внутренних нужд предприятия, но в этом случае возникают конфликты Multicast DNS(RFC6762) и невозможность использования протокола zeroconf, который реализован в Linux службой Avahi, поэтому данная зона не рекомендуется.

> [!Warning]
> Предложенные зоны .lan и .internal не зарегистрированы в глобальном списке Top-Level Domains, но всегда будет оставаться вероятность, что их ведут в эксплуатацию в будущем.
> Соответственно, следует использовать зоны .lan, .internal и .local учитывая эти риски.

::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

nano /etc/resolv.conf
# auto-generated by IPA installer
search mycop.lan
nameserver 127.0.0.1
nameserver 192.168.25.10
